generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  HOST
  EMPLOYER
  ADMIN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

// Austrian federal states (Bundesländer) for initial regional scoping
enum Region {
  BURGENLAND
  CARINTHIA
  LOWER_AUSTRIA
  SALZBURG
  STYRIA
  TIROL
  UPPER_AUSTRIA
  VIENNA
  VORARLBERG
}

// Subscription tiers
enum SubscriptionTier {
  FREE       // Free tier - 10 messages/month, browse, 1 saved search
  PLUS       // €9.90/month - unlimited messages, unlimited saved searches, alerts
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum AgreementStatus {
  DRAFT           // Agreement created but not signed
  PENDING_HOST    // Waiting for host signature
  PENDING_GUEST   // Waiting for guest signature
  FULLY_SIGNED    // Both parties signed
  ACTIVE          // Agreement in effect
  COMPLETED       // Stay/job completed successfully
  CANCELLED       // Cancelled before completion
  DISPUTED        // Under dispute resolution
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  password          String?   
  refresh_token     String? 
  access_token      String? 
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? 
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                String    @id @default(cuid())
  email             String?   @unique
  password          String?   
  emailVerified     DateTime?
  name              String?
  image             String?
  role              UserRole  @default(USER)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  
  // Contact verification
  phoneNumber       String?
  phoneVerified     DateTime?

  // Auth security
  failedLoginAttempts Int      @default(0)
  lockoutUntil        DateTime?
  resetToken          String?
  resetTokenExpiry    DateTime?
  
  // Identity verification
  identityVerified  VerificationStatus @default(PENDING)
  idDocument        String? // Document ID reference (stored separately)
  idDocumentType    String? // Passport, National ID, etc.
  
  // Additional verification for HOSTS/EMPLOYERS
  businessVerified  VerificationStatus @default(PENDING)
  businessName      String?
  businessNumber    String?
  businessDocument  String? // Business registration document reference
  
  // Address verification
  addressVerified   VerificationStatus @default(PENDING)
  address           String?
  addressDocument   String? // Proof of address document reference
  
  // Trust factors
  trustScore        Float     @default(0)
  responseRate      Float     @default(0)
  totalResponses    Int       @default(0)
  totalListings     Int       @default(0)
  
  // Extended trust metrics
  completedAgreements Int     @default(0)
  completedStays      Int     @default(0)
  reviewsGivenCount   Int     @default(0)
  reviewsReceivedCount Int    @default(0)
  storiesShared       Int     @default(0)
  culturalNotesAdded  Int     @default(0)
  helpfulFlags        Int     @default(0)
  bio                 String?
  preferredLanguage   String?
  lastActivity        DateTime @default(now())
  trustScoreLastCalculated DateTime?
  
  // Profile fields for browsable profiles
  profilePicture      String?   // S3 URL for profile picture
  dateOfBirth         DateTime?
  nationality         String?
  spokenLanguages     Json?     // Array of languages: ["English", "German", "Spanish"]
  occupation          String?
  workExperience      String?   // Years of experience in seasonal work
  skills              Json?     // Array of skills: ["Bartending", "Skiing", "Customer Service"]
  aboutMe             String?    // Extended bio/description
  interests           Json?     // Array of interests/hobbies
  availability        Json?     // Available dates/periods
  willingToRelocate   Boolean   @default(true)
  hasWorkPermit       Boolean   @default(false)
  workPermitCountries Json?     // Array of countries where they can work
  profileVisibility   String    @default("PUBLIC") // PUBLIC, SUBSCRIBERS_ONLY, PRIVATE
  openToOpportunities Boolean   @default(true)
  preferredRegions    Json?     // Array of preferred regions to work/live
  
  // Privacy settings for contact information
  emailPrivacy        String    @default("PUBLIC") // PUBLIC or HIDDEN (requires trust 80+)
  phonePrivacy        String    @default("PUBLIC") // PUBLIC or HIDDEN (requires trust 80+)
  
  // Subscription
  subscriptionTier        SubscriptionTier   @default(FREE)
  subscriptionStatus      SubscriptionStatus @default(EXPIRED)
  subscriptionExpiresAt   DateTime?
  stripeCustomerId        String?            @unique
  stripeSubscriptionId    String?            @unique
  isEarlyBird             Boolean            @default(false)
  earlyBirdSignupDate     DateTime?
  waitlistStatus          String?            @default("pending") // pending, approved, active
  
  // Relationships
  listings          Listing[]
  reviews          Review[]   @relation("ReviewsReceived")
  reviewsGiven     Review[]   @relation("ReviewsGiven")
  verificationAttempts VerificationAttempt[]
  agreementsAsHost  Agreement[] @relation("AgreementHost")
  agreementsAsGuest Agreement[] @relation("AgreementGuest")
  waitlistSignups   WaitlistSignup[] @relation("UserWaitlistSignups")
  sentMessages      Message[] @relation("SentMessages")
  receivedMessages  Message[] @relation("ReceivedMessages")
  savedListings     SavedListing[] @relation("SavedListings")
}

model Listing {
  id          String   @id @default(cuid())
  type        String   // JOB, STAY, or FLATSHARE
  title       String
  description String
  price       Float
  // Legacy free-text location (retain for existing data)
  location    String
  // New structured region and optional city for filtering
  region      Region?
  city        String?
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Featured boost fields
  isFeatured  Boolean  @default(false)
  featuredUntil DateTime? // Expiry timestamp for featured boost
  
  // Photos
  photos      Json?    // Array of base64 data URLs: ["data:image/jpeg;base64,..."]
  
  // Flatshare-specific fields
  totalRoommates     Int?        // Total number of people in the flat (e.g., 3 for a 3-person WG)
  currentRoommates   Json?       // Array of gender strings: ["FEMALE", "MALE", "FEMALE"]
  lookingForGender   String?     // "FEMALE", "MALE", or "ANY"
  spotsAvailable     Int?        // Number of available spots (default 1)
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  reviews     Review[]
  agreements  Agreement[]
  messages    Message[]
  savedBy     SavedListing[] @relation("SavedBy")
  analytics   ListingAnalytics[] @relation("ListingAnalytics")
  boosts      ListingBoost[] @relation("ListingBoosts")
  
  @@index([isFeatured, featuredUntil])
}

model Agreement {
  id              String   @id @default(cuid())
  
  // Agreement content
  preamble        String    // Human-first introduction (e.g., Innsbruck story context)
  clauses         Json     // Array of clause objects: [{title, content, order}]
  countryCode     String   @default("AT") // Country for legal context (AT = Austria)
  
  // Signatures
  signatures      Json     @default("[]") // Array: [{userId, name, signedAt, ipAddress, userAgent}]
  
  // Immutability & verification
  hash            String?  @unique // SHA-256 hash of finalized agreement content
  
  // Status & metadata
  status          AgreementStatus @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  finalizedAt     DateTime? // When both parties signed
  
  // Relations
  listingId       String
  listing         Listing  @relation(fields: [listingId], references: [id])
  hostId          String
  host            User     @relation("AgreementHost", fields: [hostId], references: [id])
  guestId         String
  guest           User     @relation("AgreementGuest", fields: [guestId], references: [id])
  
  @@index([hostId])
  @@index([guestId])
  @@index([listingId])
  @@index([status])
}

model Review {
  id          String   @id @default(cuid())
  rating      Int
  comment     String
  createdAt   DateTime @default(now())
  
  // Relations
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id])
  reviewerId  String
  reviewer    User     @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  targetId    String
  target      User     @relation("ReviewsReceived", fields: [targetId], references: [id])
}

model VerificationAttempt {
  id          String   @id @default(cuid())
  type        String   // EMAIL, PHONE, ID, BUSINESS, ADDRESS
  status      VerificationStatus
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

model LaunchSettings {
  id                    String   @id @default(cuid())
  isLaunched            Boolean  @default(false)
  earlyBirdActive       Boolean  @default(true)
  earlyBirdPrice        Float    @default(5.0)
  regularSearcherPrice  Float    @default(7.0)
  regularListerPrice    Float    @default(12.0)
  launchDate            DateTime?
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // Admin user ID who made the change
}

model WaitlistSignup {
  id             String   @id @default(cuid())
  email          String   @unique
  createdAt      DateTime @default(now())
  confirmedAt    DateTime? // If we later add email confirmation
  earlyBirdLocked Boolean  @default(false) // Has paid €5 to lock in
  paymentIntentId String?  // Stripe payment intent id (one-time)
  checkoutSessionId String? // Stripe checkout session id
  notified        Boolean  @default(false) // Launch email sent
  userId          String?  // Optional link if the email corresponds to a User
  user            User?    @relation("UserWaitlistSignups", fields: [userId], references: [id])
}

model SavedListing {
  id          String   @id @default(cuid())
  userId      String
  listingId   String
  createdAt   DateTime @default(now())

  user        User     @relation("SavedListings", fields: [userId], references: [id], onDelete: Cascade)
  listing     Listing  @relation("SavedBy", fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@index([createdAt])
}

model ListingAnalytics {
  id              String   @id @default(cuid())
  listingId       String
  date            DateTime @default(now())
  
  // View metrics
  pageViews       Int      @default(0)
  uniqueViews     Int      @default(0)
  
  // Engagement metrics
  messagesSent    Int      @default(0)
  applicationsReceived Int @default(0)
  savedCount      Int      @default(0)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  listing         Listing  @relation("ListingAnalytics", fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
  @@index([date])
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  listingId   String?
  body        String
  createdAt   DateTime @default(now())
  readAt      DateTime?

  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  recipient   User     @relation("ReceivedMessages", fields: [recipientId], references: [id])
  listing     Listing? @relation(fields: [listingId], references: [id])

  @@index([senderId, recipientId])
  @@index([listingId])
}

// Message usage tracking for quota enforcement
model MessageUsage {
  id          String   @id @default(cuid())
  userId      String
  periodStart DateTime // First day of month (YYYY-MM-01) in UTC
  sentCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, periodStart])
  @@index([userId])
  @@index([periodStart])
}

// Listing boost purchases
model ListingBoost {
  id          String   @id @default(cuid())
  listingId   String
  userId      String
  durationDays Int     // 7 or 30
  price       Float    // EUR 9.90 or 29.90
  startedAt   DateTime @default(now())
  expiresAt   DateTime
  stripePaymentIntentId String? @unique
  stripeCheckoutSessionId String? @unique
  createdAt   DateTime @default(now())

  listing     Listing  @relation("ListingBoosts", fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([userId])
  @@index([expiresAt])
}